name: Run WebInspect locally
on: [push, workflow_dispatch]

env:
  IWA_DIR:  C:\Users\Administrator\IWA-Java
  TARGET:   http://localhost:8888 

jobs:
  run_application:
    runs-on: [self-hosted, windows, x64, webinspect]
    if: needs.build.outputs.commit_status == 'success'
    steps:
      - name: terminate the app
        run: Kill-PortProcess -Port 8888
      - name: run_app
        run: mvn spring-boot:run
        with:
          sites: 'http://localhost:8888'
          expected: '200


  wi:
    runs-on: [self-hosted, windows, x64, webinspect]  
    steps:
      - name: git pull
        shell: powershell
        run: |
          git -C $env:IWA_DIR pull
      - name: localhost
        run: ls
      # - name: mvn clean package
      #   run: mvn clean package
      # - name: mvn -Pwar clean package
      #   run: mvn -Pwar clean package
      # - name: run application
      #   shell: powershell
      #   run: Start-Process -FilePath "mvn spring-boot:run" -WindowStyle Hidden -NoNewWindow
      - name: UseBasicParsing
        run: ping localhost:8888
      # - name: Wait for app to be ready
      #   shell: pwsh
      #   run: |
      #     $u = $env:TARGET
      #     1..60 | ForEach-Object {
      #       try {
      #         # если есть actuator/health - используй его
      #         Invoke-WebRequest -UseBasicParsing -TimeoutSec 3 "$u" | Out-Null
      #         exit 0
      #       } catch { Start-Sleep 2 }
      #     }
      #     throw "Service is not responding at $u"
      # - name: scanning application
      #   shell: powershell
      #   run: wi.exe -u http://192.168.64.16:8888 -ps 1 -ep ./testing.fpr
