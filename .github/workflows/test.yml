name: Run WebInspect locally
on: [push, workflow_dispatch]

env:
  IWA_DIR:  C:\Users\Administrator\IWA-Java
  TARGET:   http://192.168.64.16:8888

jobs:
  wi:
    runs-on: [self-hosted, windows, x64, webinspect1]
    timeout-minutes: 30
    steps:
      - name: Wait for app (HTTP 200 on /)
        shell: powershell
        run: |
          $u = "${{ env.TARGET }}"
          $deadline = (Get-Date).AddMinutes(3)
          while ((Get-Date) -lt $deadline) {
            try {
              Invoke-WebRequest -UseBasicParsing -TimeoutSec 3 $u | Out-Null
              Write-Host "App is up at $u"; break
            } catch { Start-Sleep 2 }
          }
          if ((Get-Date) -ge $deadline) {
            Get-Content "$env:RUNNER_TEMP\app.err.log" -Tail 200 -ErrorAction SilentlyContinue
            throw "Service is not responding at $u"
          }

      # (опционально) дополнительная проверка сторонним action
      # - name: HTTP status check
      #   uses: lakuapik/gh-actions-http-status@v1
      #   with:
      #     sites: '["http://192.168.64.16:8888"]'
      #     expected: '[200]'

      - name: Scan with WebInspect
        shell: powershell
        run: wi.exe -u "${{ env.TARGET }}" -ps 1 -ep "$env:RUNNER_TEMP\testing.fpr"

      - name: Stop app
        if: always()
        shell: powershell
        run: |
          if ($env:APP_PID) { Stop-Process -Id $env:APP_PID -Force -ErrorAction SilentlyContinue }
