name: Run WebInspect locally
on: [push, workflow_dispatch]

env:
  IWA_DIR:  C:\Users\Administrator\IWA-Java
  TARGET:   http://localhost:8888

jobs:
  wi:
    runs-on: [self-hosted, windows, x64, webinspect]
    timeout-minutes: 30
    steps:
      - name: Free port 8888 if busy
        shell: powershell
        run: |
          $c = Get-NetTCPConnection -LocalPort 8888 -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($c) { Stop-Process -Id $c.OwningProcess -Force -ErrorAction SilentlyContinue }

      - name: Update sources
        shell: powershell
        run: git -C $env:IWA_DIR pull

      - name: Start app in background
        shell: powershell
        working-directory: ${{ env.IWA_DIR }}
        run: |
          $p = Start-Process -FilePath "cmd.exe" `
            -ArgumentList "/c","mvn -q -DskipTests spring-boot:run" `
            -WindowStyle Hidden -PassThru `
            -RedirectStandardOutput "$env:RUNNER_TEMP\app.out.log" `
            -RedirectStandardError  "$env:RUNNER_TEMP\app.err.log"
          "APP_PID=$($p.Id)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Wait for app (HTTP 200 on /)
        shell: powershell
        run: |
          $u = "${{ env.TARGET }}"
          $deadline = (Get-Date).AddMinutes(3)
          while ((Get-Date) -lt $deadline) {
            try {
              Invoke-WebRequest -UseBasicParsing -TimeoutSec 3 $u | Out-Null
              Write-Host "App is up at $u"; break
            } catch { Start-Sleep 2 }
          }
          if ((Get-Date) -ge $deadline) {
            Get-Content "$env:RUNNER_TEMP\app.err.log" -Tail 200 -ErrorAction SilentlyContinue
            throw "Service is not responding at $u"
          }

      # (опционально) дополнительная проверка сторонним action
      - name: HTTP status check
        uses: lakuapik/gh-actions-http-status@v1
        with:
          sites: '["http://localhost:8888"]'
          expected: '[200]'

      - name: Scan with WebInspect
        shell: powershell
        run: wi.exe -u "${{ env.TARGET }}" -ps 1 -ep "$env:RUNNER_TEMP\testing.fpr"

      - name: Stop app
        if: always()
        shell: powershell
        run: |
          if ($env:APP_PID) { Stop-Process -Id $env:APP_PID -Force -ErrorAction SilentlyContinue }
